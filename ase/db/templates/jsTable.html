
<!-- Custom js scripts -->
<!-- NB! needs html embedding in to access jinja2 -->
<script>
  //window.location.reload(true)
  
  function SetupSuggestions()
  {
    {% set colCount = {'iter': 0} %}
    {% set colFormula = {'iter': -1} %}
    {% for c in t.columns %}
    {% if c == 'formula' %}
      {% set _dummy = colFormula.update({'iter': colCount['iter']}) %}
    {% endif %}      
    {% set _dummy = colCount.update({'iter': colCount['iter'] + 1}) %}
    {% endfor %}
          
    var formula = [];
    var formulaVis = [];
    {% set rowCount = {'iter': 0} %}
    {% for row in t.rows %}
      {% set row = row.strings[colFormula['iter']] %}
      //formulaVis[{{rowCount['iter']}}] = '{{ row|safe }}';
      var text = $("<div/>").html('{{ row|safe }}').text();
      formula[{{rowCount['iter']}}] = text;
      {% set _dummy = rowCount.update({'iter': rowCount['iter'] + 1}) %}
    {% endfor %}
    
    formula = uniq(formula);
    formulaVis = uniq(formulaVis);
      
    //sessionStorage.setItem("formulaVis", JSON.stringify(formulaVis));
    sessionStorage.setItem("formula", JSON.stringify(formula));
  }
  
  function CopyCtrl()
  {
    {% set ctrl = md['METAhelp'] or { } %}
    
    var cList = [];
    var cType = [];
    {% if ctrl|length != 0 %}
		  {% set colCount = {'iter': -1} %}
      {% for control in ctrl %}
        {% set colCount = {'iter': colCount['iter']+1} %}
        cList[{{colCount['iter']}}] = '{{ control }}';
        cType[{{colCount['iter']}}] = '{{ ctrl[control][0] }}';
      {% endfor %}
    {% endif %}
    
    sessionStorage.setItem("ctrlKeys", JSON.stringify(cList));
    sessionStorage.setItem("ctrlType", JSON.stringify(cType));
  }
  
  window.onload = function()
  {
    // reset collapse if a new session id is given
    if( sessionStorage.cid !== "{{cid}}")
    {
      sessionStorage.removeItem('collapseExtraSearch');
      
      // 
      // setup suggestions, // no way of breaking a for loop in jinja2
      SetupSuggestions();
      
      //
      // setup controls
      CopyCtrl();
    }

    ns.Init("{{ con.query|safe }}");

    // save the session id
    sessionStorage.cid = {{cid}};
    
    //$( "#formula-result" ).onchange = function()
    document.getElementById("formula-result").onchange = function()
    {
        ns.SetField('formula', this.value);
    };    
    
    document.getElementById("formula-result").focus();
  }

</script>

<script src="{{ url_for('static', filename='table.js') }}"></script>