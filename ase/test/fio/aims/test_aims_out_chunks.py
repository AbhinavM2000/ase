# flake8: noqa
import numpy as np
from ase.io import read
from ase.io.aims import AimsOutChunk, AimsOutHeaderChunk, AimsOutCalcChunk
from ase.stress import full_3x3_to_voigt_6_stress

from numpy.linalg import norm

header = [
    "| Number of atoms                   :        2",
    "| Number of Kohn-Sham states (occupied + empty):       20",
    "The structure contains        2 atoms,  and a total of         28.000 electrons.",
    "| Number of spin channels           :        2",
    "Occupation type: Gaussian broadening, width =   0.500000E-01 eV.",
    "Found relaxation constraint for atom      1: x coordinate fixed.",
    "Found relaxation constraint for atom      1: y coordinate fixed.",
    "Found relaxation constraint for atom      2: All coordinates fixed.",
    "Input geometry:",
    "| Unit cell:",
    "|        0.00000000        2.70300000        2.70300000",
    "|        2.70300000        0.00000000        2.70300000",
    "|        2.70300000        2.70300000        0.00000000",
    "| Atomic structure:",
    "|       Atom                x [A]            y [A]            z [A]",
    "|    1: Species Na            0.00000000        0.00000000        0.00000000",
    "|    2: Species Cl            2.70300000        2.70300000        2.70300000",
    "Initializing the k-points",
    "Using symmetry for reducing the k-points",
    "| k-points reduced from:        8 to        8",
    "| Number of k-points                             :         8",
    "The eigenvectors in the calculations are REAL.",
    "| K-points in task   0:         2",
    "| K-points in task   1:         2",
    "| K-points in task   2:         2",
    "| K-points in task   3:         2",
    "| k-point: 1 at     0.000000    0.000000    0.000000  , weight:   0.12500000",
    "| k-point: 2 at     0.000000    0.000000    0.500000  , weight:   0.12500000",
    "| k-point: 3 at     0.000000    0.500000    0.000000  , weight:   0.12500000",
    "| k-point: 4 at     0.000000    0.500000    0.500000  , weight:   0.12500000",
    "| k-point: 5 at     0.500000    0.000000    0.000000  , weight:   0.12500000",
    "| k-point: 6 at     0.500000    0.000000    0.500000  , weight:   0.12500000",
    "| k-point: 7 at     0.500000    0.500000    0.000000  , weight:   0.12500000",
    "| k-point: 8 at     0.500000    0.500000    0.500000  , weight:   0.12500000",
    'Geometry relaxation: A file "geometry.in.next_step" is written out by default after each step.',
    "Complete information for previous time-step:",
]

calc_lines = [
    "| Number of self-consistency cycles          :           58",
    "| N = N_up - N_down (sum over all k points):         0.00000",
    "| Chemical potential (Fermi level):    -8.24271207 eV",
    "Total atomic forces (unitary forces were cleaned, then relaxation constraints were applied) [eV/Ang]:",
    "|    1          1.000000000000000E+00          2.000000000000000E+00          3.000000000000000E+00",
    "|    2          6.000000000000000E+00          5.000000000000000E+00          4.000000000000000E+00",
    "- Per atom stress (eV) used for heat flux calculation:",
    "Atom   | Stress components (1,1), (2,2), (3,3), (1,2), (1,3), (2,3)",
    "-------------------------------------------------------------------",
    "1 |    -0.6112417237E+01   -0.6112387168E+01   -0.6112387170E+01    0.3126499410E-07    0.3125308439E-07   -0.7229688499E-07",
    "2 |     0.5613699864E+01    0.5613658189E+01    0.5613658190E+01   -0.1032586958E-06   -0.1037261077E-06    0.2151906191E-06",
    "-------------------------------------------------------------------",
    "+-------------------------------------------------------------------+",
    "|              Analytical stress tensor - Symmetrized               |",
    "|                  Cartesian components [eV/A**3]                   |",
    "+-------------------------------------------------------------------+",
    "|                x                y                z                |",
    "|                                                                   |",
    "|  x        -0.00383816      -0.00000001      -0.00000001           |",
    "|  y        -0.00000001      -0.00383829       0.00000002           |",
    "|  z        -0.00000001       0.00000002      -0.00383829           |",
    "|                                                                   |",
    "|  Pressure:       0.00383825   [eV/A**3]                           |",
    "|                                                                   |",
    "+-------------------------------------------------------------------+",
    "Energy and forces in a compact form:",
    "| Total energy uncorrected      :         -0.169503986610555E+05 eV",
    "| Total energy corrected        :         -0.169503986610555E+05 eV  <-- do not rely on this value for anything but (periodic) metals",
    "| Electronic free energy        :         -0.169503986610555E+05 eV",
    "Performing Hirshfeld analysis of fragment charges and moments.",
    "----------------------------------------------------------------------",
    "| Atom     1: Na",
    "|   Hirshfeld charge        :      0.20898543",
    "|   Free atom volume        :     82.26734086",
    "|   Hirshfeld volume        :     73.39467444",
    "|   Hirshfeld spin moment   :      0.00000000",
    "|   Hirshfeld dipole vector :      0.00000000       0.00000000      -0.00000000",
    "|   Hirshfeld dipole moment :      0.00000000",
    "|   Hirshfeld second moments:      0.19955428       0.00000002       0.00000002",
    "|                                  0.00000002       0.19955473      -0.00000005",
    "|                                  0.00000002      -0.00000005       0.19955473",
    "----------------------------------------------------------------------",
    "| Atom     2: Cl",
    "|   Hirshfeld charge        :     -0.20840994",
    "|   Free atom volume        :     65.62593663",
    "|   Hirshfeld volume        :     62.86011074",
    "|   Hirshfeld spin moment   :      0.00000000",
    "|   Hirshfeld dipole vector :      0.00000000       0.00000000       0.00000000",
    "|   Hirshfeld dipole moment :      0.00000000",
    "|   Hirshfeld second moments:      0.01482616      -0.00000001      -0.00000001",
    "|                                 -0.00000001       0.01482641       0.00000001",
    "|                                 -0.00000001       0.00000001       0.01482641",
    "----------------------------------------------------------------------",
    "Writing Kohn-Sham eigenvalues.",
    "",
    "Spin-up eigenvalues:",
    "K-point:       1 at    0.000000    0.000000    0.000000 (in units of recip. lattice)",
    "",
    "State    Occupation    Eigenvalue [Ha]    Eigenvalue [eV]",
    "1       1.00000        -101.052346        -2749.77423",
    "2       1.00000         -37.846018        -1029.84255",
    "3       1.00000          -9.207298         -250.54332",
    "4       1.00000          -6.996674         -190.38919",
    "5       1.00000          -6.996674         -190.38919",
    "6       1.00000          -6.996674         -190.38919",
    "7       1.00000          -2.086619          -56.77979",
    "8       1.00000          -1.075694          -29.27112",
    "9       1.00000          -1.075694          -29.27112",
    "10       1.00000          -1.075694          -29.27112",
    "11       1.00000          -0.764262          -20.79662",
    "12       1.00000          -0.301104           -8.19346",
    "13       1.00000          -0.301104           -8.19346",
    "14       1.00000          -0.301104           -8.19346",
    "15       0.00000          -0.133232           -3.62543",
    "16       0.00000           0.122284            3.32753",
    "17       0.00000           0.122284            3.32753",
    "18       0.00000           0.122285            3.32754",
    "19       0.00000           0.188362            5.12558",
    "20       0.00000           0.188362            5.12559",
    "",
    "Spin-down eigenvalues:",
    "K-point:       1 at    0.000000    0.000000    0.000000 (in units of recip. lattice)",
    "",
    "State    Occupation    Eigenvalue [Ha]    Eigenvalue [eV]",
    "1       1.00000        -101.052346        -2749.77423",
    "2       1.00000         -37.846018        -1029.84255",
    "3       1.00000          -9.207298         -250.54332",
    "4       1.00000          -6.996674         -190.38919",
    "5       1.00000          -6.996674         -190.38919",
    "6       1.00000          -6.996674         -190.38919",
    "7       1.00000          -2.086619          -56.77979",
    "8       1.00000          -1.075694          -29.27112",
    "9       1.00000          -1.075694          -29.27112",
    "10       1.00000          -1.075694          -29.27112",
    "11       1.00000          -0.764262          -20.79662",
    "12       1.00000          -0.301104           -8.19346",
    "13       1.00000          -0.301104           -8.19346",
    "14       1.00000          -0.301104           -8.19346",
    "15       0.00000          -0.133232           -3.62543",
    "16       0.00000           0.122284            3.32753",
    "17       0.00000           0.122284            3.32753",
    "18       0.00000           0.122285            3.32754",
    "19       0.00000           0.188362            5.12558",
    "20       0.00000           0.188362            5.12559",
    "",
    "",
    "Spin-up eigenvalues:",
    "K-point:       2 at    0.000000    0.000000    0.500000 (in units of recip. lattice)",
    "",
    "State    Occupation    Eigenvalue [Ha]    Eigenvalue [eV]",
    "1       1.00000        -101.052346        -2749.77423",
    "2       1.00000         -37.846018        -1029.84255",
    "3       1.00000          -9.207298         -250.54332",
    "4       1.00000          -6.996674         -190.38920",
    "5       1.00000          -6.996674         -190.38919",
    "6       1.00000          -6.996674         -190.38919",
    "7       1.00000          -2.086586          -56.77890",
    "8       1.00000          -1.076824          -29.30187",
    "9       1.00000          -1.075778          -29.27340",
    "10       1.00000          -1.075778          -29.27340",
    "11       1.00000          -0.750762          -20.42926",
    "12       1.00000          -0.378240          -10.29242",
    "13       1.00000          -0.311747           -8.48307",
    "14       1.00000          -0.311747           -8.48306",
    "15       0.00000          -0.045316           -1.23310",
    "16       0.00000           0.075636            2.05815",
    "17       0.00000           0.104554            2.84507",
    "18       0.00000           0.104555            2.84508",
    "19       0.00000           0.259589            7.06379",
    "20       0.00000           0.320229            8.71387",
    "",
    "Spin-down eigenvalues:",
    "K-point:       2 at    0.000000    0.000000    0.500000 (in units of recip. lattice)",
    "",
    "State    Occupation    Eigenvalue [Ha]    Eigenvalue [eV]",
    "1       1.00000        -101.052346        -2749.77423",
    "2       1.00000         -37.846018        -1029.84255",
    "3       1.00000          -9.207298         -250.54332",
    "4       1.00000          -6.996674         -190.38920",
    "5       1.00000          -6.996674         -190.38919",
    "6       1.00000          -6.996674         -190.38919",
    "7       1.00000          -2.086586          -56.77890",
    "8       1.00000          -1.076824          -29.30187",
    "9       1.00000          -1.075778          -29.27340",
    "10       1.00000          -1.075778          -29.27340",
    "11       1.00000          -0.750762          -20.42926",
    "12       1.00000          -0.378240          -10.29242",
    "13       1.00000          -0.311747           -8.48307",
    "14       1.00000          -0.311747           -8.48306",
    "15       0.00000          -0.045316           -1.23310",
    "16       0.00000           0.075636            2.05815",
    "17       0.00000           0.104554            2.84507",
    "18       0.00000           0.104555            2.84508",
    "19       0.00000           0.259589            7.06379",
    "20       0.00000           0.320229            8.71387",
    "",
    "",
    "Spin-up eigenvalues:",
    "K-point:       3 at    0.000000    0.500000    0.000000 (in units of recip. lattice)",
    "",
    "State    Occupation    Eigenvalue [Ha]    Eigenvalue [eV]",
    "1       1.00000        -101.052346        -2749.77423",
    "2       1.00000         -37.846018        -1029.84255",
    "3       1.00000          -9.207298         -250.54332",
    "4       1.00000          -6.996674         -190.38920",
    "5       1.00000          -6.996674         -190.38919",
    "6       1.00000          -6.996674         -190.38919",
    "7       1.00000          -2.086586          -56.77890",
    "8       1.00000          -1.076824          -29.30187",
    "9       1.00000          -1.075778          -29.27340",
    "10       1.00000          -1.075778          -29.27340",
    "11       1.00000          -0.750762          -20.42926",
    "12       1.00000          -0.378240          -10.29242",
    "13       1.00000          -0.311747           -8.48307",
    "14       1.00000          -0.311747           -8.48306",
    "15       0.00000          -0.045316           -1.23310",
    "16       0.00000           0.075636            2.05815",
    "17       0.00000           0.104554            2.84507",
    "18       0.00000           0.104555            2.84508",
    "19       0.00000           0.259589            7.06379",
    "20       0.00000           0.320229            8.71387",
    "",
    "Spin-down eigenvalues:",
    "K-point:       3 at    0.000000    0.500000    0.000000 (in units of recip. lattice)",
    "",
    "State    Occupation    Eigenvalue [Ha]    Eigenvalue [eV]",
    "1       1.00000        -101.052346        -2749.77423",
    "2       1.00000         -37.846018        -1029.84255",
    "3       1.00000          -9.207298         -250.54332",
    "4       1.00000          -6.996674         -190.38920",
    "5       1.00000          -6.996674         -190.38919",
    "6       1.00000          -6.996674         -190.38919",
    "7       1.00000          -2.086586          -56.77890",
    "8       1.00000          -1.076824          -29.30187",
    "9       1.00000          -1.075778          -29.27340",
    "10       1.00000          -1.075778          -29.27340",
    "11       1.00000          -0.750762          -20.42926",
    "12       1.00000          -0.378240          -10.29242",
    "13       1.00000          -0.311747           -8.48307",
    "14       1.00000          -0.311747           -8.48306",
    "15       0.00000          -0.045316           -1.23310",
    "16       0.00000           0.075636            2.05815",
    "17       0.00000           0.104554            2.84507",
    "18       0.00000           0.104555            2.84508",
    "19       0.00000           0.259589            7.06379",
    "20       0.00000           0.320229            8.71387",
    "",
    "",
    "Spin-up eigenvalues:",
    "K-point:       4 at    0.000000    0.500000    0.500000 (in units of recip. lattice)",
    "",
    "State    Occupation    Eigenvalue [Ha]    Eigenvalue [eV]",
    "1       1.00000        -101.052346        -2749.77423",
    "2       1.00000         -37.846018        -1029.84255",
    "3       1.00000          -9.207298         -250.54332",
    "4       1.00000          -6.996674         -190.38919",
    "5       1.00000          -6.996674         -190.38919",
    "6       1.00000          -6.996674         -190.38919",
    "7       1.00000          -2.086575          -56.77860",
    "8       1.00000          -1.076491          -29.29280",
    "9       1.00000          -1.076015          -29.27984",
    "10       1.00000          -1.076014          -29.27984",
    "11       1.00000          -0.748853          -20.37731",
    "12       1.00000          -0.367549          -10.00153",
    "13       1.00000          -0.324951           -8.84236",
    "14       1.00000          -0.324951           -8.84236",
    "15       0.00000          -0.043001           -1.17011",
    "16       0.00000           0.010911            0.29690",
    "17       0.00000           0.110273            3.00069",
    "18       0.00000           0.239812            6.52562",
    "19       0.00000           0.239812            6.52562",
    "20       0.00000           0.252921            6.88232",
    "",
    "Spin-down eigenvalues:",
    "K-point:       4 at    0.000000    0.500000    0.500000 (in units of recip. lattice)",
    "",
    "State    Occupation    Eigenvalue [Ha]    Eigenvalue [eV]",
    "1       1.00000        -101.052346        -2749.77423",
    "2       1.00000         -37.846018        -1029.84255",
    "3       1.00000          -9.207298         -250.54332",
    "4       1.00000          -6.996674         -190.38919",
    "5       1.00000          -6.996674         -190.38919",
    "6       1.00000          -6.996674         -190.38919",
    "7       1.00000          -2.086575          -56.77860",
    "8       1.00000          -1.076491          -29.29280",
    "9       1.00000          -1.076015          -29.27984",
    "10       1.00000          -1.076014          -29.27984",
    "11       1.00000          -0.748853          -20.37731",
    "12       1.00000          -0.367549          -10.00153",
    "13       1.00000          -0.324951           -8.84236",
    "14       1.00000          -0.324951           -8.84236",
    "15       0.00000          -0.043001           -1.17011",
    "16       0.00000           0.010911            0.29690",
    "17       0.00000           0.110273            3.00069",
    "18       0.00000           0.239812            6.52562",
    "19       0.00000           0.239812            6.52562",
    "20       0.00000           0.252921            6.88232",
    "",
    "",
    "Spin-up eigenvalues:",
    "K-point:       5 at    0.500000    0.000000    0.000000 (in units of recip. lattice)",
    "",
    "State    Occupation    Eigenvalue [Ha]    Eigenvalue [eV]",
    "1       1.00000        -101.052346        -2749.77423",
    "2       1.00000         -37.846018        -1029.84255",
    "3       1.00000          -9.207298         -250.54332",
    "4       1.00000          -6.996674         -190.38920",
    "5       1.00000          -6.996674         -190.38919",
    "6       1.00000          -6.996674         -190.38919",
    "7       1.00000          -2.086586          -56.77890",
    "8       1.00000          -1.076824          -29.30187",
    "9       1.00000          -1.075778          -29.27340",
    "10       1.00000          -1.075778          -29.27340",
    "11       1.00000          -0.750762          -20.42926",
    "12       1.00000          -0.378240          -10.29242",
    "13       1.00000          -0.311747           -8.48306",
    "14       1.00000          -0.311747           -8.48306",
    "15       0.00000          -0.045316           -1.23310",
    "16       0.00000           0.075636            2.05815",
    "17       0.00000           0.104554            2.84507",
    "18       0.00000           0.104555            2.84508",
    "19       0.00000           0.259590            7.06379",
    "20       0.00000           0.320229            8.71387",
    "",
    "Spin-down eigenvalues:",
    "K-point:       5 at    0.500000    0.000000    0.000000 (in units of recip. lattice)",
    "",
    "State    Occupation    Eigenvalue [Ha]    Eigenvalue [eV]",
    "1       1.00000        -101.052346        -2749.77423",
    "2       1.00000         -37.846018        -1029.84255",
    "3       1.00000          -9.207298         -250.54332",
    "4       1.00000          -6.996674         -190.38920",
    "5       1.00000          -6.996674         -190.38919",
    "6       1.00000          -6.996674         -190.38919",
    "7       1.00000          -2.086586          -56.77890",
    "8       1.00000          -1.076824          -29.30187",
    "9       1.00000          -1.075778          -29.27340",
    "10       1.00000          -1.075778          -29.27340",
    "11       1.00000          -0.750762          -20.42926",
    "12       1.00000          -0.378240          -10.29242",
    "13       1.00000          -0.311747           -8.48306",
    "14       1.00000          -0.311747           -8.48306",
    "15       0.00000          -0.045316           -1.23310",
    "16       0.00000           0.075636            2.05815",
    "17       0.00000           0.104554            2.84507",
    "18       0.00000           0.104555            2.84508",
    "19       0.00000           0.259590            7.06379",
    "20       0.00000           0.320229            8.71387",
    "",
    "",
    "Spin-up eigenvalues:",
    "K-point:       6 at    0.500000    0.000000    0.500000 (in units of recip. lattice)",
    "",
    "State    Occupation    Eigenvalue [Ha]    Eigenvalue [eV]",
    "1       1.00000        -101.052346        -2749.77423",
    "2       1.00000         -37.846018        -1029.84255",
    "3       1.00000          -9.207298         -250.54332",
    "4       1.00000          -6.996674         -190.38919",
    "5       1.00000          -6.996674         -190.38919",
    "6       1.00000          -6.996674         -190.38919",
    "7       1.00000          -2.086575          -56.77860",
    "8       1.00000          -1.076491          -29.29280",
    "9       1.00000          -1.076014          -29.27984",
    "10       1.00000          -1.076014          -29.27984",
    "11       1.00000          -0.748853          -20.37731",
    "12       1.00000          -0.367549          -10.00153",
    "13       1.00000          -0.324951           -8.84236",
    "14       1.00000          -0.324951           -8.84235",
    "15       0.00000          -0.043001           -1.17011",
    "16       0.00000           0.010911            0.29690",
    "17       0.00000           0.110273            3.00068",
    "18       0.00000           0.239812            6.52562",
    "19       0.00000           0.239813            6.52564",
    "20       0.00000           0.252921            6.88232",
    "",
    "Spin-down eigenvalues:",
    "K-point:       6 at    0.500000    0.000000    0.500000 (in units of recip. lattice)",
    "",
    "State    Occupation    Eigenvalue [Ha]    Eigenvalue [eV]",
    "1       1.00000        -101.052346        -2749.77423",
    "2       1.00000         -37.846018        -1029.84255",
    "3       1.00000          -9.207298         -250.54332",
    "4       1.00000          -6.996674         -190.38919",
    "5       1.00000          -6.996674         -190.38919",
    "6       1.00000          -6.996674         -190.38919",
    "7       1.00000          -2.086575          -56.77860",
    "8       1.00000          -1.076491          -29.29280",
    "9       1.00000          -1.076014          -29.27984",
    "10       1.00000          -1.076014          -29.27984",
    "11       1.00000          -0.748853          -20.37731",
    "12       1.00000          -0.367549          -10.00153",
    "13       1.00000          -0.324951           -8.84236",
    "14       1.00000          -0.324951           -8.84235",
    "15       0.00000          -0.043001           -1.17011",
    "16       0.00000           0.010911            0.29690",
    "17       0.00000           0.110273            3.00068",
    "18       0.00000           0.239812            6.52562",
    "19       0.00000           0.239813            6.52564",
    "20       0.00000           0.252921            6.88232",
    "",
    "",
    "Spin-up eigenvalues:",
    "K-point:       7 at    0.500000    0.500000    0.000000 (in units of recip. lattice)",
    "",
    "State    Occupation    Eigenvalue [Ha]    Eigenvalue [eV]",
    "1       1.00000        -101.052346        -2749.77423",
    "2       1.00000         -37.846018        -1029.84255",
    "3       1.00000          -9.207298         -250.54332",
    "4       1.00000          -6.996674         -190.38919",
    "5       1.00000          -6.996674         -190.38919",
    "6       1.00000          -6.996674         -190.38919",
    "7       1.00000          -2.086575          -56.77860",
    "8       1.00000          -1.076491          -29.29280",
    "9       1.00000          -1.076014          -29.27984",
    "10       1.00000          -1.076014          -29.27984",
    "11       1.00000          -0.748853          -20.37731",
    "12       1.00000          -0.367549          -10.00153",
    "13       1.00000          -0.324951           -8.84236",
    "14       1.00000          -0.324951           -8.84235",
    "15       0.00000          -0.043001           -1.17011",
    "16       0.00000           0.010911            0.29690",
    "17       0.00000           0.110273            3.00068",
    "18       0.00000           0.239812            6.52562",
    "19       0.00000           0.239813            6.52564",
    "20       0.00000           0.252921            6.88232",
    "",
    "Spin-down eigenvalues:",
    "K-point:       7 at    0.500000    0.500000    0.000000 (in units of recip. lattice)",
    "",
    "State    Occupation    Eigenvalue [Ha]    Eigenvalue [eV]",
    "1       1.00000        -101.052346        -2749.77423",
    "2       1.00000         -37.846018        -1029.84255",
    "3       1.00000          -9.207298         -250.54332",
    "4       1.00000          -6.996674         -190.38919",
    "5       1.00000          -6.996674         -190.38919",
    "6       1.00000          -6.996674         -190.38919",
    "7       1.00000          -2.086575          -56.77860",
    "8       1.00000          -1.076491          -29.29280",
    "9       1.00000          -1.076014          -29.27984",
    "10       1.00000          -1.076014          -29.27984",
    "11       1.00000          -0.748853          -20.37731",
    "12       1.00000          -0.367549          -10.00153",
    "13       1.00000          -0.324951           -8.84236",
    "14       1.00000          -0.324951           -8.84235",
    "15       0.00000          -0.043001           -1.17011",
    "16       0.00000           0.010911            0.29690",
    "17       0.00000           0.110273            3.00068",
    "18       0.00000           0.239812            6.52562",
    "19       0.00000           0.239813            6.52564",
    "20       0.00000           0.252921            6.88232",
    "",
    "",
    "Spin-up eigenvalues:",
    "K-point:       8 at    0.500000    0.500000    0.500000 (in units of recip. lattice)",
    "",
    "State    Occupation    Eigenvalue [Ha]    Eigenvalue [eV]",
    "1       1.00000        -101.052346        -2749.77423",
    "2       1.00000         -37.846018        -1029.84255",
    "3       1.00000          -9.207298         -250.54332",
    "4       1.00000          -6.996674         -190.38920",
    "5       1.00000          -6.996674         -190.38919",
    "6       1.00000          -6.996674         -190.38919",
    "7       1.00000          -2.086586          -56.77890",
    "8       1.00000          -1.076824          -29.30187",
    "9       1.00000          -1.075778          -29.27340",
    "10       1.00000          -1.075778          -29.27340",
    "11       1.00000          -0.750762          -20.42926",
    "12       1.00000          -0.378240          -10.29242",
    "13       1.00000          -0.311747           -8.48306",
    "14       1.00000          -0.311747           -8.48306",
    "15       0.00000          -0.045316           -1.23310",
    "16       0.00000           0.075636            2.05815",
    "17       0.00000           0.104554            2.84507",
    "18       0.00000           0.104555            2.84508",
    "19       0.00000           0.259590            7.06379",
    "20       0.00000           0.320229            8.71387",
    "",
    "Spin-down eigenvalues:",
    "K-point:       8 at    0.500000    0.500000    0.500000 (in units of recip. lattice)",
    "",
    "State    Occupation    Eigenvalue [Ha]    Eigenvalue [eV]",
    "1       1.00000        -101.052346        -2749.77423",
    "2       1.00000         -37.846018        -1029.84255",
    "3       1.00000          -9.207298         -250.54332",
    "4       1.00000          -6.996674         -190.38920",
    "5       1.00000          -6.996674         -190.38919",
    "6       1.00000          -6.996674         -190.38919",
    "7       1.00000          -2.086586          -56.77890",
    "8       1.00000          -1.076824          -29.30187",
    "9       1.00000          -1.075778          -29.27340",
    "10       1.00000          -1.075778          -29.27340",
    "11       1.00000          -0.750762          -20.42926",
    "12       1.00000          -0.378240          -10.29242",
    "13       1.00000          -0.311747           -8.48306",
    "14       1.00000          -0.311747           -8.48306",
    "15       0.00000          -0.045316           -1.23310",
    "16       0.00000           0.075636            2.05815",
    "17       0.00000           0.104554            2.84507",
    "18       0.00000           0.104555            2.84508",
    "19       0.00000           0.259590            7.06379",
    "20       0.00000           0.320229            8.71387",
    "",
    "Current spin moment of the entire structure :",
    "| N = N_up - N_down (sum over all k points):         0.00000",
    "| S (sum over all k points)                :         0.00000",
    "",
    "What follows are estimated values for band gap, HOMO, LUMO, etc.",
    "| They are estimated on a discrete k-point grid and not necessarily exact.",
    "| For converged numbers, create a DOS and/or band structure plot on a denser k-grid.",
    "",
    "Highest occupied state (VBM) at     -8.19345940 eV (relative to internal zero)",
    "| Occupation number:      1.00000000",
    "| K-point:       1 at    0.000000    0.000000    0.000000 (in units of recip. lattice)",
    "| Spin channel:        1",
    "",
    "Lowest unoccupied state (CBM) at    -3.62542909 eV (relative to internal zero)",
    "| Occupation number:      0.00000000",
    "| K-point:       1 at    0.000000    0.000000    0.000000 (in units of recip. lattice)",
    "| Spin channel:        1",
    "",
    "ESTIMATED overall HOMO-LUMO gap:      4.56803031 eV between HOMO at k-point 1 and LUMO at k-point 1",
    "| This appears to be a direct band gap.",
    "The gap value is above 0.2 eV. Unless you are using a very sparse k-point grid",
    "this system is most likely an insulator or a semiconductor.",
    "| Chemical Potential                          :    -7.44914181 eV",
    "",
    "Self-consistency cycle converged.",
    "material is metallic within the approximate finite broadening function (occupation_type)",
    "Have a nice day.",
    "------------------------------------------------------------",
    "",
]
eigenvalues_occupancies = np.zeros((8, 20, 2, 2))

eigenvalues_occupancies[0, :, 0, :] = [
    [1.00000, -2749.77423],
    [1.00000, -1029.84255],
    [1.00000, -250.54332],
    [1.00000, -190.38919],
    [1.00000, -190.38919],
    [1.00000, -190.38919],
    [1.00000, -56.77979],
    [1.00000, -29.27112],
    [1.00000, -29.27112],
    [1.00000, -29.27112],
    [1.00000, -20.79662],
    [1.00000, -8.19346],
    [1.00000, -8.19346],
    [1.00000, -8.19346],
    [0.00000, -3.62543],
    [0.00000, 3.32753],
    [0.00000, 3.32753],
    [0.00000, 3.32754],
    [0.00000, 5.12558],
    [0.00000, 5.12559],
]

eigenvalues_occupancies[0, :, 1, :] = [
    [1.00000, -2749.77423],
    [1.00000, -1029.84255],
    [1.00000, -250.54332],
    [1.00000, -190.38919],
    [1.00000, -190.38919],
    [1.00000, -190.38919],
    [1.00000, -56.77979],
    [1.00000, -29.27112],
    [1.00000, -29.27112],
    [1.00000, -29.27112],
    [1.00000, -20.79662],
    [1.00000, -8.19346],
    [1.00000, -8.19346],
    [1.00000, -8.19346],
    [0.00000, -3.62543],
    [0.00000, 3.32753],
    [0.00000, 3.32753],
    [0.00000, 3.32754],
    [0.00000, 5.12558],
    [0.00000, 5.12559],
]

eigenvalues_occupancies[1, :, 0, :] = [
    [1.00000, -2749.77423],
    [1.00000, -1029.84255],
    [1.00000, -250.54332],
    [1.00000, -190.38920],
    [1.00000, -190.38919],
    [1.00000, -190.38919],
    [1.00000, -56.77890],
    [1.00000, -29.30187],
    [1.00000, -29.27340],
    [1.00000, -29.27340],
    [1.00000, -20.42926],
    [1.00000, -10.29242],
    [1.00000, -8.48307],
    [1.00000, -8.48306],
    [0.00000, -1.23310],
    [0.00000, 2.05815],
    [0.00000, 2.84507],
    [0.00000, 2.84508],
    [0.00000, 7.06379],
    [0.00000, 8.71387],
]

eigenvalues_occupancies[1, :, 1, :] = [
    [1.00000, -2749.77423],
    [1.00000, -1029.84255],
    [1.00000, -250.54332],
    [1.00000, -190.38920],
    [1.00000, -190.38919],
    [1.00000, -190.38919],
    [1.00000, -56.77890],
    [1.00000, -29.30187],
    [1.00000, -29.27340],
    [1.00000, -29.27340],
    [1.00000, -20.42926],
    [1.00000, -10.29242],
    [1.00000, -8.48307],
    [1.00000, -8.48306],
    [0.00000, -1.23310],
    [0.00000, 2.05815],
    [0.00000, 2.84507],
    [0.00000, 2.84508],
    [0.00000, 7.06379],
    [0.00000, 8.71387],
]

eigenvalues_occupancies[2, :, 0, :] = [
    [1.00000, -2749.77423],
    [1.00000, -1029.84255],
    [1.00000, -250.54332],
    [1.00000, -190.38920],
    [1.00000, -190.38919],
    [1.00000, -190.38919],
    [1.00000, -56.77890],
    [1.00000, -29.30187],
    [1.00000, -29.27340],
    [1.00000, -29.27340],
    [1.00000, -20.42926],
    [1.00000, -10.29242],
    [1.00000, -8.48307],
    [1.00000, -8.48306],
    [0.00000, -1.23310],
    [0.00000, 2.05815],
    [0.00000, 2.84507],
    [0.00000, 2.84508],
    [0.00000, 7.06379],
    [0.00000, 8.71387],
]

eigenvalues_occupancies[2, :, 1, :] = [
    [1.00000, -2749.77423],
    [1.00000, -1029.84255],
    [1.00000, -250.54332],
    [1.00000, -190.38920],
    [1.00000, -190.38919],
    [1.00000, -190.38919],
    [1.00000, -56.77890],
    [1.00000, -29.30187],
    [1.00000, -29.27340],
    [1.00000, -29.27340],
    [1.00000, -20.42926],
    [1.00000, -10.29242],
    [1.00000, -8.48307],
    [1.00000, -8.48306],
    [0.00000, -1.23310],
    [0.00000, 2.05815],
    [0.00000, 2.84507],
    [0.00000, 2.84508],
    [0.00000, 7.06379],
    [0.00000, 8.71387],
]

eigenvalues_occupancies[3, :, 0, :] = [
    [1.00000, -2749.77423],
    [1.00000, -1029.84255],
    [1.00000, -250.54332],
    [1.00000, -190.38919],
    [1.00000, -190.38919],
    [1.00000, -190.38919],
    [1.00000, -56.77860],
    [1.00000, -29.29280],
    [1.00000, -29.27984],
    [1.00000, -29.27984],
    [1.00000, -20.37731],
    [1.00000, -10.00153],
    [1.00000, -8.84236],
    [1.00000, -8.84236],
    [0.00000, -1.17011],
    [0.00000, 0.29690],
    [0.00000, 3.00069],
    [0.00000, 6.52562],
    [0.00000, 6.52562],
    [0.00000, 6.88232],
]

eigenvalues_occupancies[3, :, 1, :] = [
    [1.00000, -2749.77423],
    [1.00000, -1029.84255],
    [1.00000, -250.54332],
    [1.00000, -190.38919],
    [1.00000, -190.38919],
    [1.00000, -190.38919],
    [1.00000, -56.77860],
    [1.00000, -29.29280],
    [1.00000, -29.27984],
    [1.00000, -29.27984],
    [1.00000, -20.37731],
    [1.00000, -10.00153],
    [1.00000, -8.84236],
    [1.00000, -8.84236],
    [0.00000, -1.17011],
    [0.00000, 0.29690],
    [0.00000, 3.00069],
    [0.00000, 6.52562],
    [0.00000, 6.52562],
    [0.00000, 6.88232],
]

eigenvalues_occupancies[4, :, 0, :] = [
    [1.00000, -2749.77423],
    [1.00000, -1029.84255],
    [1.00000, -250.54332],
    [1.00000, -190.38920],
    [1.00000, -190.38919],
    [1.00000, -190.38919],
    [1.00000, -56.77890],
    [1.00000, -29.30187],
    [1.00000, -29.27340],
    [1.00000, -29.27340],
    [1.00000, -20.42926],
    [1.00000, -10.29242],
    [1.00000, -8.48306],
    [1.00000, -8.48306],
    [0.00000, -1.23310],
    [0.00000, 2.05815],
    [0.00000, 2.84507],
    [0.00000, 2.84508],
    [0.00000, 7.06379],
    [0.00000, 8.71387],
]

eigenvalues_occupancies[4, :, 1, :] = [
    [1.00000, -2749.77423],
    [1.00000, -1029.84255],
    [1.00000, -250.54332],
    [1.00000, -190.38920],
    [1.00000, -190.38919],
    [1.00000, -190.38919],
    [1.00000, -56.77890],
    [1.00000, -29.30187],
    [1.00000, -29.27340],
    [1.00000, -29.27340],
    [1.00000, -20.42926],
    [1.00000, -10.29242],
    [1.00000, -8.48306],
    [1.00000, -8.48306],
    [0.00000, -1.23310],
    [0.00000, 2.05815],
    [0.00000, 2.84507],
    [0.00000, 2.84508],
    [0.00000, 7.06379],
    [0.00000, 8.71387],
]

eigenvalues_occupancies[5, :, 0, :] = [
    [1.00000, -2749.77423],
    [1.00000, -1029.84255],
    [1.00000, -250.54332],
    [1.00000, -190.38919],
    [1.00000, -190.38919],
    [1.00000, -190.38919],
    [1.00000, -56.77860],
    [1.00000, -29.29280],
    [1.00000, -29.27984],
    [1.00000, -29.27984],
    [1.00000, -20.37731],
    [1.00000, -10.00153],
    [1.00000, -8.84236],
    [1.00000, -8.84235],
    [0.00000, -1.17011],
    [0.00000, 0.29690],
    [0.00000, 3.00068],
    [0.00000, 6.52562],
    [0.00000, 6.52564],
    [0.00000, 6.88232],
]

eigenvalues_occupancies[5, :, 1, :] = [
    [1.00000, -2749.77423],
    [1.00000, -1029.84255],
    [1.00000, -250.54332],
    [1.00000, -190.38919],
    [1.00000, -190.38919],
    [1.00000, -190.38919],
    [1.00000, -56.77860],
    [1.00000, -29.29280],
    [1.00000, -29.27984],
    [1.00000, -29.27984],
    [1.00000, -20.37731],
    [1.00000, -10.00153],
    [1.00000, -8.84236],
    [1.00000, -8.84235],
    [0.00000, -1.17011],
    [0.00000, 0.29690],
    [0.00000, 3.00068],
    [0.00000, 6.52562],
    [0.00000, 6.52564],
    [0.00000, 6.88232],
]

eigenvalues_occupancies[6, :, 0, :] = [
    [1.00000, -2749.77423],
    [1.00000, -1029.84255],
    [1.00000, -250.54332],
    [1.00000, -190.38919],
    [1.00000, -190.38919],
    [1.00000, -190.38919],
    [1.00000, -56.77860],
    [1.00000, -29.29280],
    [1.00000, -29.27984],
    [1.00000, -29.27984],
    [1.00000, -20.37731],
    [1.00000, -10.00153],
    [1.00000, -8.84236],
    [1.00000, -8.84235],
    [0.00000, -1.17011],
    [0.00000, 0.29690],
    [0.00000, 3.00068],
    [0.00000, 6.52562],
    [0.00000, 6.52564],
    [0.00000, 6.88232],
]

eigenvalues_occupancies[6, :, 1, :] = [
    [1.00000, -2749.77423],
    [1.00000, -1029.84255],
    [1.00000, -250.54332],
    [1.00000, -190.38919],
    [1.00000, -190.38919],
    [1.00000, -190.38919],
    [1.00000, -56.77860],
    [1.00000, -29.29280],
    [1.00000, -29.27984],
    [1.00000, -29.27984],
    [1.00000, -20.37731],
    [1.00000, -10.00153],
    [1.00000, -8.84236],
    [1.00000, -8.84235],
    [0.00000, -1.17011],
    [0.00000, 0.29690],
    [0.00000, 3.00068],
    [0.00000, 6.52562],
    [0.00000, 6.52564],
    [0.00000, 6.88232],
]

eigenvalues_occupancies[7, :, 0, :] = [
    [1.00000, -2749.77423],
    [1.00000, -1029.84255],
    [1.00000, -250.54332],
    [1.00000, -190.38920],
    [1.00000, -190.38919],
    [1.00000, -190.38919],
    [1.00000, -56.77890],
    [1.00000, -29.30187],
    [1.00000, -29.27340],
    [1.00000, -29.27340],
    [1.00000, -20.42926],
    [1.00000, -10.29242],
    [1.00000, -8.48306],
    [1.00000, -8.48306],
    [0.00000, -1.23310],
    [0.00000, 2.05815],
    [0.00000, 2.84507],
    [0.00000, 2.84508],
    [0.00000, 7.06379],
    [0.00000, 8.71387],
]

eigenvalues_occupancies[7, :, 1, :] = [
    [1.00000, -2749.77423],
    [1.00000, -1029.84255],
    [1.00000, -250.54332],
    [1.00000, -190.38920],
    [1.00000, -190.38919],
    [1.00000, -190.38919],
    [1.00000, -56.77890],
    [1.00000, -29.30187],
    [1.00000, -29.27340],
    [1.00000, -29.27340],
    [1.00000, -20.42926],
    [1.00000, -10.29242],
    [1.00000, -8.48306],
    [1.00000, -8.48306],
    [0.00000, -1.23310],
    [0.00000, 2.05815],
    [0.00000, 2.84507],
    [0.00000, 2.84508],
    [0.00000, 7.06379],
    [0.00000, 8.71387],
]

k_points = np.array(
    [
        [0.000, 0.000, 0.000],
        [0.000, 0.000, 0.500],
        [0.000, 0.500, 0.000],
        [0.000, 0.500, 0.500],
        [0.500, 0.000, 0.000],
        [0.500, 0.000, 0.500],
        [0.500, 0.500, 0.000],
        [0.500, 0.500, 0.500],
    ]
)

k_point_weights = np.full((8), 0.125)


def test_AimsOutChunkUtils():
    lines = ["TEST", "A", "TEST", "| Number of atoms: 200 atoms"]
    chunk = AimsOutChunk(lines)
    assert chunk.reverse_search_for(["TEST"]) == 2
    assert chunk.reverse_search_for(["TEST"], 1) == 2

    assert chunk.reverse_search_for(["TEST A"]) == 4

    assert chunk.reverse_search_for(["A"]) == 1
    assert chunk.reverse_search_for(["A"], 2) == 4

    assert chunk.search_for_all("TEST") == [0, 2]
    assert chunk.search_for_all("TEST", 0, 1) == [0]
    assert chunk.search_for_all("TEST", 1, -1) == [2]

    assert chunk.parse_scalar("n_atoms") == 200


def test_AimsOutHeaderChunk():
    lines = []
    chunk = AimsOutHeaderChunk(lines)

    # Test the critical elements that should raise IOErrors
    try:
        n_atoms = chunk.n_atoms
        assert (
            False
        ), "Not passing information about the number of atoms should be a fatal error"

    except IOError:
        pass

    try:
        n_bands = chunk.n_bands
        assert (
            False
        ), "Not passing information about the number of bands should be a fatal error"
    except IOError:
        pass

    try:
        n_electrons = chunk.n_electrons
        assert (
            False
        ), "Not passing information about the number of electrons should be a fatal error"
    except IOError:
        pass

    try:
        n_spins = chunk.n_spins
        assert (
            False
        ), "Not passing information about the number of spin channels should be a fatal error"
    except IOError:
        pass

    try:
        atoms = chunk.initial_atoms
        assert (
            False
        ), "Not passing information about the initial structure should be a fatal error"
    except IOError:
        pass

    # Check that all default calls are working
    assert chunk.electronic_temperature == 0.1
    assert chunk.constraints is None
    assert chunk.initial_cell is None
    assert not chunk.is_md
    assert not chunk.is_relaxation
    assert chunk.n_k_points is None
    assert chunk.k_points is None
    assert chunk.k_point_weights is None

    # Check that the header can be properly parsed

    chunk = AimsOutHeaderChunk(header)

    assert chunk.n_atoms == 2
    assert chunk.n_bands == 20
    assert chunk.n_electrons == 28
    assert chunk.n_spins == 2

    assert len(chunk.constraints) == 2
    assert chunk.constraints[0].index == 0
    assert chunk.constraints[1].index == 1
    assert np.all(chunk.constraints[0].mask == [False, False, True])

    assert len(chunk.initial_atoms) == 2
    assert np.allclose(
        chunk.initial_atoms.cell,
        np.array([[0.000, 2.703, 2.703], [2.703, 0.000, 2.703], [2.703, 2.703, 0.000]]),
    )
    assert np.allclose(
        chunk.initial_cell,
        np.array([[0.000, 2.703, 2.703], [2.703, 0.000, 2.703], [2.703, 2.703, 0.000]]),
    )
    assert np.allclose(
        chunk.initial_atoms.positions,
        np.array([[0.000, 0.000, 0.000], [2.703, 2.703, 2.703]]),
    )
    assert np.all(["Na", "Cl"] == chunk.initial_atoms.symbols)
    assert all(
        [
            str(const_1) == str(const_2)
            for const_1, const_2 in zip(
                chunk.constraints, chunk.initial_atoms.constraints
            )
        ]
    )

    assert chunk.electronic_temperature == 0.05
    assert chunk.is_md
    assert chunk.is_relaxation

    assert chunk.n_k_points == 8
    assert np.allclose(chunk.k_point_weights, k_point_weights)
    assert np.allclose(chunk.k_points, k_points)
    header_summary = {
        "initial_atoms": chunk.initial_atoms,
        "initial_cell": chunk.initial_cell,
        "constraints": chunk.constraints,
        "is_relaxation": True,
        "is_md": True,
        "n_atoms": 2,
        "n_bands": 20,
        "n_electrons": 28,
        "n_spins": 2,
        "electronic_temperature": 0.05,
        "n_k_points": 8,
        "k_points": k_points,
        "k_point_weights": k_point_weights,
    }
    for key, val in chunk.header_summary.items():
        if isinstance(val, np.ndarray):
            assert np.allclose(val, header_summary[key])
        else:
            assert val == header_summary[key]


def test_AimsOutCalcChunk():
    lines = []
    header_chunk = AimsOutHeaderChunk(header[:-1])
    chunk = AimsOutCalcChunk(lines, header_chunk)

    # Test that the header passing works
    assert chunk.n_atoms == 2
    assert chunk.n_bands == 20
    assert chunk.n_electrons == 28
    assert chunk.n_spins == 2

    assert len(chunk.constraints) == 2
    assert chunk.constraints[0].index == 0
    assert chunk.constraints[1].index == 1
    assert np.all(chunk.constraints[0].mask == [False, False, True])

    assert len(chunk.initial_atoms) == 2
    assert np.allclose(
        chunk.initial_cell,
        np.array([[0.000, 2.703, 2.703], [2.703, 0.000, 2.703], [2.703, 2.703, 0.000]]),
    )
    assert np.allclose(
        chunk.initial_atoms.positions,
        np.array([[0.000, 0.000, 0.000], [2.703, 2.703, 2.703]]),
    )
    assert np.all(["Na", "Cl"] == chunk.initial_atoms.symbols)
    assert all(
        [
            str(const_1) == str(const_2)
            for const_1, const_2 in zip(
                chunk.constraints, chunk.initial_atoms.constraints
            )
        ]
    )

    assert chunk.electronic_temperature == 0.05

    assert chunk.n_k_points == 8
    assert np.allclose(chunk.k_point_weights, k_point_weights)
    assert np.allclose(chunk.k_points, k_points)

    # Test the critical elements that should raise IOErrors
    try:
        energy = chunk.energy
        assert (
            False
        ), "Not passing information about the number of atoms should be a fatal error"

    except IOError:
        pass

    # Check that all default calls are working
    assert chunk.forces is None
    assert chunk.stresses is None
    assert chunk.stress is None
    assert chunk.free_energy is None
    assert chunk.n_iter is None
    assert chunk.magmom is None
    assert chunk.E_f is None
    assert chunk.dipole is None
    assert not chunk.is_metallic
    assert not chunk.converged
    assert chunk.hirshfeld_charges is None
    assert chunk.hirshfeld_volumes is None
    assert chunk.hirshfeld_atomic_dipoles is None
    assert chunk.hirshfeld_dipole is None
    assert chunk.eigenvalues is None
    assert chunk.occupancies is None

    chunk = AimsOutCalcChunk(calc_lines, header_chunk)
    assert len(chunk.atoms) == 2
    assert np.allclose(
        chunk.atoms.cell,
        np.array([[0.000, 2.703, 2.703], [2.703, 0.000, 2.703], [2.703, 2.703, 0.000]]),
    )
    assert np.allclose(
        chunk.atoms.positions,
        np.array([[0.000, 0.000, 0.000], [2.703, 2.703, 2.703]]),
    )
    assert np.all(["Na", "Cl"] == chunk.atoms.symbols)
    assert all(
        [
            str(const_1) == str(const_2)
            for const_1, const_2 in zip(chunk.constraints, chunk.atoms.constraints)
        ]
    )

    assert np.allclose(chunk.forces, np.array([[1.0, 2.0, 3.0], [6.0, 5.0, 4.0]]))

    # Different because of the constraints
    assert np.allclose(
        chunk.atoms.get_forces(), np.array([[0.0, 0.0, 3.0], [0.0, 0.0, 0.0]])
    )
    assert np.allclose(
        chunk.atoms.get_forces(apply_constraint=False),
        np.array([[1.0, 2.0, 3.0], [6.0, 5.0, 4.0]]),
    )
    assert np.allclose(
        chunk.results["forces"], np.array([[1.0, 2.0, 3.0], [6.0, 5.0, 4.0]])
    )

    stresses = np.array(
        [
            [
                -0.6112417237e01,
                -0.6112387168e01,
                -0.6112387170e01,
                -0.7229688499e-07,
                0.3125308439e-07,
                0.3126499410e-07,
            ],
            [
                0.5613699864e01,
                0.5613658189e01,
                0.5613658190e01,
                0.2151906191e-06,
                -0.1037261077e-06,
                -0.1032586958e-06,
            ],
        ]
    )
    assert np.allclose(chunk.stresses, stresses)
    assert np.allclose(chunk.atoms.get_stresses(), stresses)
    assert np.allclose(chunk.results["stresses"], stresses)

    stress = full_3x3_to_voigt_6_stress(
        np.array(
            [
                [-0.00383816, -0.00000001, -0.00000001],
                [-0.00000001, -0.00383829, 0.00000002],
                [-0.00000001, 0.00000002, -0.00383829],
            ]
        )
    )
    assert np.allclose(chunk.stress, stress)
    assert np.allclose(chunk.atoms.get_stress(), stress)
    assert np.allclose(chunk.results["stress"], stress)

    assert np.abs(chunk.free_energy + 0.169503986610555e05) < 1e-15
    assert np.abs(chunk.results["free_energy"] + 0.169503986610555e05) < 1e-15

    assert np.abs(chunk.energy + 0.169503986610555e05) < 1e-15
    assert np.abs(chunk.atoms.get_potential_energy() + 0.169503986610555e05) < 1e-15
    assert np.abs(chunk.results["energy"] + 0.169503986610555e05) < 1e-15

    assert chunk.magmom == 0
    assert chunk.atoms.get_magnetic_moment() == 0
    assert chunk.results["magmom"] == 0

    assert chunk.n_iter == 58
    assert chunk.results["n_iter"] == 58

    assert np.abs(chunk.E_f + 8.24271207) < 1e-7
    assert np.abs(chunk.results["fermi_energy"] + 8.24271207) < 1e-7

    assert chunk.dipole is None
    assert chunk.is_metallic
    assert chunk.converged

    assert np.allclose(chunk.hirshfeld_charges, [0.20898543, -0.20840994])
    assert np.allclose(chunk.hirshfeld_volumes, [73.39467444, 62.86011074])
    assert np.allclose(chunk.hirshfeld_atomic_dipoles, np.zeros((2, 3)))
    assert chunk.hirshfeld_dipole is None

    assert np.allclose(chunk.results["hirshfeld_charges"], [0.20898543, -0.20840994])
    assert np.allclose(chunk.results["hirshfeld_volumes"], [73.39467444, 62.86011074])
    assert np.allclose(chunk.results["hirshfeld_atomic_dipoles"], np.zeros((2, 3)))

    assert np.allclose(chunk.eigenvalues, eigenvalues_occupancies[:, :, :, 1])
    assert np.allclose(chunk.occupancies, eigenvalues_occupancies[:, :, :, 0])
    assert np.allclose(
        chunk.results["eigenvalues"], eigenvalues_occupancies[:, :, :, 1]
    )
    assert np.allclose(
        chunk.results["occupancies"], eigenvalues_occupancies[:, :, :, 0]
    )


def test_AimsOutCalcChunkMolecular():
    header = [
        "| Number of atoms                   :        3",
        "| Number of Kohn-Sham states (occupied + empty):       11",
        "The structure contains        2 atoms,  and a total of         10.000 electrons.",
        "| Number of spin channels           :        1",
        "Input geometry:",
        "| Atomic structure:",
        "|       Atom                x [A]            y [A]            z [A]",
        "|    1: Species O             0.00000000        0.00000000        0.00000000",
        "|    2: Species H             0.95840000        0.00000000        0.00000000",
        "|    3: Species H            -0.24000000        0.92790000        0.00000000",
        'Geometry relaxation: A file "geometry.in.next_step" is written out by default after each step.',
    ]
    calc = [
        "| Number of self-consistency cycles          :           7",
        "| Chemical Potential                          :    -0.61315483 eV",
        "Updated atomic structure:",
        "x [A]             y [A]             z [A]",
        "atom        -0.00191785       -0.00243279        0.00000000  O",
        "atom         0.97071531       -0.00756333        0.00000000  H",
        "atom        -0.25039746        0.93789612       -0.00000000  H",
        "| Total dipole moment [eAng]          :          0.260286493869765E+00         0.336152447755231E+00         0.470003778119121E-15",
        "Energy and forces in a compact form:",
        "| Total energy uncorrected      :         -0.206778551123339E+04 eV",
        "| Total energy corrected        :         -5.206778551123339E+04 eV  <-- do not rely on this value for anything but (periodic) metals",
        "| Electronic free energy        :         -0.206778551123339E+04 eV",
        "Total atomic forces (unitary forces cleaned) [eV/Ang]:",
        "|    1          0.502371357164392E-03          0.518627676606471E-03          0.000000000000000E+00",
        "|    2         -0.108826758257187E-03         -0.408128912334209E-03         -0.649037698626122E-27",
        "|    3         -0.393544598907207E-03         -0.110498764272267E-03         -0.973556547939183E-27",
        "Performing Hirshfeld analysis of fragment charges and moments.",
        "----------------------------------------------------------------------",
        "| Atom     1: O",
        "|   Hirshfeld charge        :     -0.32053200",
        "|   Free atom volume        :     23.59848617",
        "|   Hirshfeld volume        :     21.83060659",
        "|   Hirshfeld dipole vector :      0.04249319       0.05486053       0.00000000",
        "|   Hirshfeld dipole moment :      0.06939271",
        "|   Hirshfeld second moments:      0.04964380      -0.04453278      -0.00000000",
        "|                                 -0.04453278       0.02659295       0.00000000",
        "|                                 -0.00000000       0.00000000      -0.05608173",
        "----------------------------------------------------------------------",
        "| Atom     2: H",
        "|   Hirshfeld charge        :      0.16022630",
        "|   Free atom volume        :     10.48483941",
        "|   Hirshfeld volume        :      6.07674041",
        "|   Hirshfeld dipole vector :      0.13710134      -0.00105126       0.00000000",
        "|   Hirshfeld dipole moment :      0.13710537",
        "|   Hirshfeld second moments:      0.12058896      -0.01198026      -0.00000000",
        "|                                 -0.01198026       0.14550360       0.00000000",
        "|                                 -0.00000000       0.00000000       0.10836357",
        "----------------------------------------------------------------------",
        "| Atom     3: H",
        "|   Hirshfeld charge        :      0.16020375",
        "|   Free atom volume        :     10.48483941",
        "|   Hirshfeld volume        :      6.07684447",
        "|   Hirshfeld dipole vector :     -0.03534982       0.13248706       0.00000000",
        "|   Hirshfeld dipole moment :      0.13712195",
        "|   Hirshfeld second moments:      0.14974686      -0.00443579      -0.00000000",
        "|                                 -0.00443579       0.11633028      -0.00000000",
        "|                                 -0.00000000      -0.00000000       0.10836209",
        "----------------",
        "Writing Kohn-Sham eigenvalues.",
        "",
        "State    Occupation    Eigenvalue [Ha]    Eigenvalue [eV]",
        "1       2.00000         -18.640915         -507.24511",
        "2       2.00000          -0.918449          -24.99226",
        "3       2.00000          -0.482216          -13.12175",
        "4       2.00000          -0.338691           -9.21626",
        "5       2.00000          -0.264427           -7.19543",
        "6       0.00000          -0.000414           -0.01127",
        "7       0.00000           0.095040            2.58616",
        "8       0.00000           0.295251            8.03419",
        "9       0.00000           0.328307            8.93368",
        "10       0.00000           0.369311           10.04947",
        "11       0.00000           0.578060           15.72981",
        "",
        "Highest occupied state (VBM) at     -7.19542820 eV",
        "| Occupation number:      2.00000000",
        "",
        "Lowest unoccupied state (CBM) at    -0.01126981 eV",
        "| Occupation number:      0.00000000",
        "",
        "Overall HOMO-LUMO gap:      7.18415839 eV.",
        "| Chemical Potential                          :    -0.61315483 eV",
        "",
        "Self-consistency cycle converged.",
        "Have a nice day.",
        "------------------------------------------------------------",
        "",
    ]
    header_chunk = AimsOutHeaderChunk(header[:-1])
    assert header_chunk.k_points is None
    assert header_chunk.k_point_weights is None
    assert header_chunk.constraints is None
    assert header_chunk.initial_cell is None
    assert header_chunk.n_k_points is None

    chunk = AimsOutCalcChunk(calc, header_chunk)
    assert chunk.initial_cell is None
    assert np.allclose(
        chunk.initial_atoms.positions,
        np.array(
            [
                [0.00000000, 0.00000000, 0.00000000],
                [0.95840000, 0.00000000, 0.00000000],
                [-0.24000000, 0.92790000, 0.00000000],
            ]
        ),
    )

    positions = np.array(
        [
            [-0.00191785, -0.00243279, 0.00000000],
            [0.97071531, -0.00756333, 0.00000000],
            [-0.25039746, 0.93789612, 0.00000000],
        ]
    )
    assert len(chunk.atoms) == 3
    assert np.allclose(chunk.atoms.positions, positions)
    assert np.all(["O", "H", "H"] == chunk.atoms.symbols)

    forces = np.array(
        [
            [0.502371357164392e-03, 0.518627676606471e-03, 0.000000000000000e00],
            [-0.108826758257187e-03, -0.408128912334209e-03, -0.649037698626122e-27],
            [-0.393544598907207e-03, -0.110498764272267e-03, -0.973556547939183e-27],
        ]
    )
    assert np.allclose(chunk.forces, forces)
    assert np.allclose(chunk.atoms.get_forces(), forces)
    assert np.allclose(chunk.results["forces"], forces)

    assert chunk.stresses is None
    assert chunk.stress is None

    assert np.abs(chunk.free_energy + 0.206778551123339e04) < 1e-15
    assert np.abs(chunk.results["free_energy"] + 0.206778551123339e04) < 1e-15

    assert np.abs(chunk.energy + 0.206778551123339e04) < 1e-15
    assert np.abs(chunk.atoms.get_potential_energy() + 0.206778551123339e04) < 1e-15
    assert np.abs(chunk.results["energy"] + 0.206778551123339e04) < 1e-15

    assert chunk.magmom is None

    assert chunk.n_iter == 7
    assert chunk.results["n_iter"] == 7

    assert chunk.E_f is None

    dipole = [0.260286493869765, 0.336152447755231, 0.470003778119121e-15]
    assert np.allclose(chunk.dipole, dipole)
    assert np.allclose(chunk.atoms.get_dipole_moment(), dipole)
    assert np.allclose(chunk.results["dipole"], dipole)

    assert not chunk.is_metallic
    assert chunk.converged

    hirshfeld_charges = np.array([-0.32053200, 0.16022630, 0.16020375])
    hirshfeld_volumes = np.array([21.83060659, 6.07674041, 6.07684447])
    hirshfeld_atomic_dipoles = np.array(
        [
            [0.04249319, 0.05486053, 0.00000000],
            [0.13710134, -0.00105126, 0.00000000],
            [-0.03534982, 0.13248706, 0.00000000],
        ]
    )
    hirshfeld_dipole = np.sum(hirshfeld_charges.reshape((-1, 1)) * positions, axis=1)
    assert np.allclose(chunk.hirshfeld_charges, hirshfeld_charges)
    assert np.allclose(chunk.hirshfeld_volumes, hirshfeld_volumes)
    assert np.allclose(chunk.hirshfeld_atomic_dipoles, hirshfeld_atomic_dipoles)
    assert np.allclose(chunk.hirshfeld_dipole, hirshfeld_dipole)

    assert np.allclose(chunk.results["hirshfeld_charges"], hirshfeld_charges)
    assert np.allclose(chunk.results["hirshfeld_volumes"], hirshfeld_volumes)
    assert np.allclose(
        chunk.results["hirshfeld_atomic_dipoles"], hirshfeld_atomic_dipoles
    )
    assert np.allclose(chunk.results["hirshfeld_dipole"], hirshfeld_dipole)

    eigenvalues = [
        -507.24511,
        -24.99226,
        -13.12175,
        -9.21626,
        -7.19543,
        -0.01127,
        2.58616,
        8.03419,
        8.93368,
        10.04947,
        15.72981,
    ]
    occupancies = [
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
    ]
    assert np.allclose(chunk.eigenvalues[0, :, 0], eigenvalues)
    assert np.allclose(chunk.occupancies[0, :, 0], occupancies)
    assert np.allclose(chunk.results["eigenvalues"][0, :, 0], eigenvalues)
    assert np.allclose(chunk.results["occupancies"][0, :, 0], occupancies)
