"""
Construct a 10 Angstrom x 10 Angstrom x 10 Angstrom non-periodic cell
filled with randomly positioned atoms and compute the energy, forces,
and virial stress for a model that makes use of multiple cutoffs
"""
import numpy as np
from ase import Atoms
from ase.calculators.kim import KIM

# Set up a cluster of atoms
positions = np.array(
    [
        [2.736406858344856, 7.49909592841974, 9.271397748704091],
        [1.9089365928095148, 3.983256909411008, 3.828160485471842],
        [0.9946074244836967, 6.276872962234595, 3.8556868007727383],
        [0.6419379047765184, 4.607337364188658, 8.903649817163858],
        [8.500008198718183, 7.137138517171805, 2.4506632713168552],
        [4.593115477242652, 8.094830619158046, 3.306858552951782],
        [7.753648990430486, 9.30523727629631, 4.036697777752002],
        [4.939034790202377, 3.154190959215386, 7.818533218166376],
        [5.901142546789947, 7.832293971682653, 2.816950656367351],
        [3.09787319671854, 3.8234169005471297, 2.4990077123706476],
        [9.365498638631351, 5.722122230617638, 7.977754884313363],
        [5.64523459763726, 8.609944406904004, 0.7936204382403889],
        [1.5137916922068195, 3.8715667966354017, 6.0479675915090425],
        [8.919855718049863, 1.363606743765634, 9.836484377551685],
        [5.723513775142694, 1.7932421840483448, 0.3245066563853094],
    ]
)

energy_ref = 35.980581554926
forces_ref = np.array(
    [
        [7.48420197e-02, 1.08256665e-01, 1.27327371e-02],
        [-1.19652134e01, -4.73481592e-01, 1.03971288e01],
        [-1.20227427e00, 2.89162817e00, -8.74699008e-02],
        [-2.27702820e-01, 2.32511616e-02, 4.58957850e-01],
        [1.74632618e00, -1.28347054e00, -7.76646327e-01],
        [-5.95904245e01, 1.16032723e01, 2.31245701e01],
        [9.98492845e-01, 1.82432933e00, 1.44968066e00],
        [5.12307348e-02, -1.37878674e-02, 1.40926826e-02],
        [5.73216863e01, -1.46790964e01, -1.66251165e01],
        [1.39853885e01, -1.97553083e00, -1.56356855e01],
        [2.25834933e-03, 1.30744576e-02, -5.66122336e-03],
        [-4.38265160e-01, 2.56423365e00, -7.16666310e00],
        [-7.93081659e-01, -5.70987822e-01, 4.85342258e00],
        [7.06305446e-03, -1.36818468e-02, 8.38384863e-03],
        [2.96737795e-02, -1.80088519e-02, -2.17266847e-02],
    ]
)

stress_ref = np.array(
    [-0.1033228, -0.01624876, -0.06198772, -0.00528729, 0.0487454, 0.02048859]
)

modelname = "ex_model_Ar_P_Morse_MultiCutoff"

calc = KIM(modelname)

atoms = Atoms(
    "Ar" * 15, positions=positions, pbc=False, cell=[[10, 0, 0], [0, 10, 0], [0, 0, 10]]
)
atoms.set_calculator(calc)

energy = atoms.get_potential_energy()
forces = atoms.get_forces()
stress = atoms.get_stress()

tol = 1e-6
assert np.isclose(energy, energy_ref, tol)
assert np.allclose(forces, forces_ref, tol)
assert np.allclose(stress, stress_ref, tol)
